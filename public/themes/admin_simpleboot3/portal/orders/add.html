<include file="public@header"/>
<style>
    img{ cursor: pointer}
    .Xk {
        background-color: #62a8d1;
        position: relative;
        padding: 10px 0;
        margin-bottom: 2px;;
    }
    .green {
        color: #fff!important;
        line-height: 28px;
        padding-left: 0;
        width: 80%;
    }
</style>
</head>
<body>
<div class="wrap">
    <ul class="nav nav-tabs">
        <li><a href="{:url('portal/orders/index')}">开课列表</a></li>
        <li><a href="{:url('orders/logs')}">开课日志</a></li>
        <li class="active"><a href="#">添加新课程</a></li>
    </ul>
    <form class="form-horizontal margin-top-20"  role="form" method="POST" id="add_customer" enctype="multipart/form-data">
        <input type="hidden" name="applicant" id="applicant" value="{$applicant}">
        <input type="hidden" name="check_name" id="check_name" value="{$check_name}">
        <input type="hidden" name="group_id" id="group_id" value="{$group_id}">
        <div class="space-4"></div>
        <div class="form-group">
            <label class="col-sm-3 control-label no-padding-right">手机号</label>

            <div class="col-sm-6">
                <input type="text" name="phone" id="phone" placeholder="请输入学员手机号" class="form-control" />
            </div>
        </div>
        <div class="space-4"></div>

        <div class="form-group">
            <label class="col-sm-3 control-label no-padding-right">用户名</label>

            <div class="col-sm-6">
                <input type="text" name="username" id="username" placeholder="请输入学员用户名" class="form-control" />
                <span id="check_user" style="display: none" class="red">*该用户还没注册</span>
            </div>
        </div>
        <div class="form-group">
            <label class="col-sm-3 control-label no-padding-right">用户姓名</label>

            <div class="col-sm-6">
                <input type="text" name="name" id="name" placeholder="请输入用户姓名" class="form-control" />
            </div>
        </div>
        <div class="form-group">
            <label class="col-sm-3 control-label no-padding-right">身份证号</label>

            <div class="col-sm-6">
                <input type="text" name="cardno" id="cardno" placeholder="请输入身份证号" class="form-control" />
            </div>
        </div>
        <div class="space-4"></div>

        <div class="form-group">
          <label class="col-sm-3 control-label no-padding-right">上传身份证图片</label>
          <div class="col-sm-6">
            <div class="col-sm-5 text-center">
                <div class="text-center"><img width="120" id="card_face_img" onclick="$('#card_face').click()" src="__STATIC__/images/default.png">
                <input type="file" style="display: none" id="card_face" onchange="setdeafultpic(this,'card_face')" name="card_face"  /></div>
                <div class="text-center margin-top-10">身份证正面照片</div>
            </div>
            <div class="col-sm-5">
                <div class="text-center"><img width="120" id="card_back_img" onclick="$('#card_back').click()" src="__STATIC__/images/default.png">
                <input type="file" id="card_back" style="display: none" onchange="setdeafultpic(this,'card_back')" name="card_back" /></div>
                <div class="text-center margin-top-10">身份证反面照片</div>
            </div>
           </div>
        </div>
        <div class="space-4"></div>

        <div class="form-group">
            <label class="col-sm-3 control-label no-padding-right">考 区</label>

            <div class="col-sm-6">
                <input type="text" name="province" id="province" placeholder="请输入考区" class="form-control" />
            </div>
        </div>
        <div class="space-4"></div>

        <div class="form-group">
            <label class="col-sm-3 control-label no-padding-right">地 址</label>

            <div class="col-sm-6">
                <input type="text" name="address" id="address" placeholder="请输入地 址" class="form-control" />
            </div>
        </div>
        <div class="space-4"></div>

        <div class="form-group">
            <label class="col-sm-3 control-label no-padding-right">工作单位</label>

            <div class="col-sm-6">
                <input type="text" name="company" id="company" placeholder="请输入工作单位" class="form-control" />
            </div>
        </div>
        <div class="space-4"></div>
        <div class="form-group">
            <label class="col-sm-3 control-label no-padding-right">学员邮箱</label>

            <div class="col-sm-6">
                <input type="text" name="email" id="email" class="form-control" />
            </div>
        </div>

        <div class="space-4"></div>

        <div class="form-group">
            <label class="col-sm-3 control-label no-padding-right">课程ID</label>
            <div class="col-sm-6">
                <input style="width: 160px;" readonly data-toggle="modal" data-target="#myModal" name="goods_id" id="goods_id" placeholder="请输入要开课程的ID" class="form-control" />
            </div>
        </div>

        <div class="Hz"></div>

        <div class="space-4"></div>
        <div class="form-group owe_time">
            <label class="col-sm-3 control-label no-padding-right">欠款补交时间</label>
            <div class="col-sm-6">
                <input type="text" name="owe_time" placeholder="" class="form-control js-bootstrap-datetime"
                       value="{$start_time|default=''}" autocomplete="off" />
            </div>
        </div>
        <div class="space-4"></div>
        <div class="form-group">
            <label class="col-sm-3 control-label no-padding-right">转账方式</label>
            <div class="col-sm-6">
                <select name="pay_way" class="form-control">
                    <option value="微信">微信</option>
                    <option value="支付宝">支付宝</option>
                    <option value="银行卡">银行卡</option>
                    <option value="刷卡">刷卡</option>
                </select>
            </div>
        </div>
        <div class="space-4"></div>
        <div class="form-group">
            <label class="col-sm-3 control-label no-padding-right">转账截图</label>
            <div class="col-sm-6">
                <div class="col-sm-3 text-center">
                    <img width="120" id="pay_pic1_img" onclick="$('#pay_pic1').click()" src="__STATIC__/images/default.png">
                    <input type="file" name="pay_pic1"  style="display: none" id="pay_pic1" onchange="setdeafultpic(this,'pay_pic1')" />
                </div>
                <div class="col-sm-3 text-center">
                    <img width="120" id="pay_pic2_img" onclick="$('#pay_pic2').click()" src="__STATIC__/images/default.png">
                    <input type="file" name="pay_pic2"  style="display: none" id="pay_pic2" onchange="setdeafultpic(this,'pay_pic2')" />
                </div>
                <div class="col-sm-3 text-center">
                    <img width="120" id="pay_pic3_img" onclick="$('#pay_pic3').click()" src="__STATIC__/images/default.png">
                    <input type="file" name="pay_pic3"  style="display: none" id="pay_pic3" onchange="setdeafultpic(this,'pay_pic3')" />
                </div>
                <div class="col-sm-3 text-center">
                    <img width="120" id="pay_pic4_img" onclick="$('#pay_pic4').click()" src="__STATIC__/images/default.png">
                    <input type="file" name="pay_pic4"  style="display: none" id="pay_pic4" onchange="setdeafultpic(this,'pay_pic4')" />
                </div>
            </div>
        </div>
        <div class="form-group">
            <label class="col-sm-3 control-label no-padding-right">协议（图片）</label>
            <div class="col-sm-6">
                <div class="col-sm-3 text-center">
                    <img width="120" id="agreement1_img" onclick="$('#agreement1').click()" src="__STATIC__/images/default.png">
                    <input type="file" name="agreement1" style="display: none" id="agreement1" onchange="setdeafultpic(this,'agreement1')" />
                </div>
                <div class="col-sm-3 text-center">
                    <img width="120" id="agreement2_img" onclick="$('#agreement2').click()" src="__STATIC__/images/default.png">
                    <input type="file" name="agreement2" style="display: none" id="agreement2" onchange="setdeafultpic(this,'agreement2')" />
                </div>
                <div class="col-sm-3 text-center">
                    <img width="120" id="agreement3_img" onclick="$('#agreement3').click()" src="__STATIC__/images/default.png">
                    <input type="file" name="agreement3" style="display: none" id="agreement3" onchange="setdeafultpic(this,'agreement3')" />
                </div>
                <div class="col-sm-3 text-center">
                    <img width="120" id="agreement4_img" onclick="$('#agreement4').click()" src="__STATIC__/images/default.png">
                    <input type="file" name="agreement4" style="display: none" id="agreement4" onchange="setdeafultpic(this,'agreement4')" />
                </div>
            </div>
        </div>
        <div class="space-4"></div>

        <div class="form-group">
            <label class="col-sm-3 control-label no-padding-right">协议（word文档）</label>
            <div class="col-sm-6">
                <input type="file" name="agreement" id="agreement" />
            </div>
        </div>
        <div class="space-4"></div>

        <div class="form-group">
            <label class="col-sm-3 control-label no-padding-right">备注</label>

            <div class="col-sm-6">
                <textarea class="form-control" rows="5" name="remarks" id="content"></textarea>
            </div>
        </div>

        <div class="clearfix form-actions">
            <div class="col-md-offset-3 col-md-9">
                <button class="btn btn-info" type="button"  onclick="return checkdate()">
                    <i class="icon-ok bigger-110"></i>
                    保存
                </button>
                <button class="btn" type="reset">
                    <i class="icon-undo bigger-110"></i>
                    重置
                </button>
                <button class="btn" type="button" onclick="window.history.back()">
                    <i class="icon-reply bigger-110"></i>
                    返回
                </button>
            </div>
        </div>
    </form>

    <script>
        function wsinfo(){
            var Socket =  io.connect(ws_url);
            var content = $("#phone").val();     //学员手机号
            var student = $("#username").val();     //学员姓名
            var applicant = $("#applicant").val(); //申请人
            var goodsname = $("#goods_id").val(); //课程id
            var course_money = 0;    //$("#course_money").val();   //课程费用
            var pay_money = 0;    //$("#pay_money").val();     //已支付费用
            var check_name = $("#check_name").val();     //审核人
            var goodstype_subject_id = 1;   //$("#goodstype_subject_id").val();     //是否为正常订单
            var group_id = $("#group_id").val();
            //alert("ok");
            //告诉服务器端有用户登录
            // if(!isEmpty(content)){
            var sendData =  {
                student:student,
                applicant:applicant,
                goodsname:goodsname,
                course_money:course_money,
                pay_money:pay_money,
                username:check_name,
                content:content,
                group_id:group_id,
                type_id:goodstype_subject_id
            };
            //alert(check_name);
            //Socket.emit('login', {userid:'1', username:'redwe'});
            Socket.emit('message',sendData);
            console.log(sendData);
            //}
        }

        function checkdate(){
            var phone = $("#phone").val();
            var username = $("#username").val();

            if(!isEmpty(phone) || !isEmpty(username)){
                alert("请输入电话和用户名再提交！");
                return false;
            }
            var email = $("#email").val();
            var address = $("#address").val();
            if(!isEmpty(email) || !isEmpty(address)){
                alert("请输入邮箱和地址再提交！");
                return false;
            }
            var company = $("#company").val();
            var province = $("#province").val();
            if(!isEmpty(province) || !isEmpty(company)){
                alert("请输入单位和考区再提交！");
                return false;
            }

            //alert(checkMoney('course_money'));
            if(!checkMoney('course_money')){
                alert("请输入成交金额再提交！");
                return false;
            }

            if(!checkMoney('pay_money')){
                alert("请输入已付金额再提交！");
                return false;
            }

            wsinfo();
            setTimeout(function(){
                add_customer.submit();
            },1000);

        }
        //course_money、pay_money
        function checkMoney(moneys){
            $temp = '';
            $("."+moneys).each(function(){
                var money = $(this).val();
                if(!isEmpty(money)){
                    return false;
                }
                else
                {
                    $temp += ","+money;
                }
            });
            return $temp;
        }
    </script>

    <div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="false">
        <div class="modal-dialog" style="width: 1200px;">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                    <h4 class="modal-title" id="myModalLabel">选择课程</h4>
                </div>
                <div class="modal-body">
                    <form class="sform">
                        <div class="form-group">
                            <input type="text" class="form-control" style="width: 360px; float: left; margin-right: 10px;" id="title" placeholder="课程名称" name="title">
                            <button type="button" style="height: 33px; padding-top: 2px;" class="btn btn-default saveBtn">搜索</button>
                        </div>
                    </form>
                    <table id="example-advanced" class="table table-striped table-bordered table-hover">
                        <thead>
                        <tr>
                            <th>课程ID</th>
                            <th>课程名称</th>
                            <th>创建时间</th>
                            <th>操作</th>
                        </tr>
                        </thead>
                        <tbody class="data_show">
                          <foreach name="goods_data" item="vo">
                            <tr>
                                <td>{$vo.id}</td>
                                <td>{$vo.post_title}</td>
                                <td>{$vo.create_time|date="Y-m-d H:i:s",###}</td>
                                <td><input name="goods_id" class="goods_id" type="checkbox" value="{$vo['id']}" data-name="{$vo['post_title']}" /></td>
                            </tr>
                        </foreach>
                        </tbody>
                    </table>
                    <div class="pagination">{$pages}</div>

                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>
                    <button type="button" class="btn btn-primary cateBtn">提交更改</button>
                </div>
            </div>
            <!-- /.modal-content -->
        </div>
        <!-- /.modal -->

</div><!-- /.col -->
<script src="__STATIC__/js/admin.js"></script>
<script src="__STATIC__/js/common.js"></script>
<script>
    selectId();
    function AjaxPage(page){
        $.ajax({
            url: '{:url(\'Orders/add\')}',
            data: {
                title: '',
                goods_type:'',
                page:page
            },
            dataType: 'json',
            type: 'post',
            success: function(e) {
                if(isEmpty(e)){
                    $(".data_show").html(e.goods_data);
                    $(".pagination").html(e.pages);
                    console.log(e);
                }
            }
        });
    }
    var goods_id = new Array();
    //选择ID
    function selectId() {
        $('.cateBtn').click(function() {
            $('.Hz').empty();
            //alert('OK');
            $("input[type='checkbox']:checked").each(function() {
                //
                if(goods_id){
                    if(Array.isArray(goods_id)){
                        goods_id.push($(this).val()); //向数组中添加元素
                    }
                    else
                    {
                        if(goods_id.indexOf(",")>-1){
                            goods_id = goods_id.split(",");
                            goods_id.push($(this).val()); //向数组中添加元素
                        }
                    }
                }
                else
                {
                    goods_id.push($(this).val()); //向数组中添加元素
                }

            });
            goods_id.sort();
            goods_id = unique1(goods_id);
            console.log(goods_id);
            var goods_id2 = goods_id.join(','); //将数组元素连接起来以构建一个字符串
            $("#goods_txt").html(goods_id2);
            //console.log(goods_id);
            //var goods_id = $("input[type='checkbox']:checked").val();
            $('#goods_id').val(goods_id2);
            if(goods_id2) {
                $.ajax({
                    url: '{:url(\'Orders/getGoodsArray\')}',
                    data: {
                        goods_id: goods_id2
                    },
                    dataType: 'json',
                    type: 'post',
                    success: function(e) {
                        console.log(e);
                        //$('.goods_name').text(e.data.post_title);
                        kc_arr = e.data;

                        var html = "";
                        for(var i = 0; i < kc_arr.length; i++) {
                            html = '<div class="Xk">' +
                            '<div class="form-group"><label class="col-sm-3 control-label no-padding-right">课程名称</label><div class="col-sm-6">' +
                            '<span class="goods_name col-sm-5 green">' + kc_arr[i].post_title + '(id:' + kc_arr[i].id+ ')</span> ' +
                            '<input data-key="'+i+'" data-id="'+kc_arr[i].id+'" type="button" value="删除" class="hkremove"></div></div>' +
                            '<div class="form-group"><label class="col-sm-3 control-label no-padding-right">课程年限</label><div class="col-sm-6">'+
                            '<select name="kc_type[]" data-id="'+i+'" class="kc_type">';
                            if(kc_arr[i].year_price1 != '') {
                                html += '<option value="1" data-price=' + kc_arr[i].year_price1 + '>一年</option>';
                            }
                            if(kc_arr[i].year_price2 != 0 && kc_arr[i].year_price2 != '') {
                                html += '<option value="2" data-price=' + kc_arr[i].year_price2 + '>二年</option>';
                            }
                            if(kc_arr[i].year_price3 != 0 && kc_arr[i].year_price3 != '') {
                                html += '<option value="3" data-price=' + kc_arr[i].year_price3 + '>三年</option>';
                            }

                            html += '</select></div></div>' +
                            '<div class="form-group"><label class="col-sm-3 control-label no-padding-right">课程费用</label><div class="col-sm-6">'+
                            '<input value=' + kc_arr[i].year_price1 + ' type="text" readonly="" name="kc_price[]" id="kc_price'+i+'" placeholder="请选择课程年限" class="form-control kc_price kcSelect"> '+
                            '</div></div>' +
                            '<div class="form-group"><label class="col-sm-3 control-label no-padding-right">成交金额</label><div class="col-sm-6">'+
                            '<input value="" type="text" name="course_money[]" id="total_money'+i+'" placeholder="请输入实际成交金额" class="form-control course_money">'+
                            '</div></div>';


                            html += '<div class="form-group"><label class="col-sm-3 control-label no-padding-right">已交费用</label><div class="col-sm-6">'+
                            '<input type="text" name="pay_money[]" data-key="'+i+'" id="pay_money'+i+'" placeholder="" class="form-control pay_money" />'+
                            '</div></div>';
                            html += '</div>';

                            $('.Hz').append(html);

                        }
                        $('.form-horizontal').on('change','.Hz .Xk select',function(){

                            var price = $(this).find("option:selected").data('price');
                            var pi = $(this).data("id");
                            $(this).parent().parent().parent().find("#kc_price"+pi).val(price);
                        });

                        $('.hkremove').click(function(){
                            var idlist = new Array();
                            var pi = $(this).data("id");
                            var key = $(this).data("key");
                            //var goods_id0 = $("#goods_id").val();
                            for(var k=0;k<goods_id.length;k++){
                                if(goods_id[k] != pi){
                                //if(k != key){
                                    idlist.push(goods_id[k]);
                                }
                            }
                            idlist.sort();
                            goods_id = idlist;
                            $("#goods_id").val(idlist);
                            console.log(key);
                            $(this).parent().parent().parent().remove();
                        })

                        $(".pay_money").on('blur',function(){
                            var key = $(this).data('key');
                            var pay_money = parseInt($(this).val());
                            //console.log(pay_money);
                            var total_money = parseInt($('#total_money'+key).val());
                            //console.log(total_money);
                        })

                    }
                });
            }
            $('#myModal').modal('hide');
        });
    }

    function unique1(arr){
        var hash=[];
        for (var i = 0; i < arr.length; i++) {
            for (var j = i+1; j < arr.length; j++) {
                if(arr[i]===arr[j]){
                    ++i;
                }
            }
            hash.push(arr[i]);
        }
        return hash;
    }

    $('#phone').bind('input blur', function() {
        var phone = $('#phone').val();
        if(phone) {
            $.ajax({
                url: '{:url(\'Orders/getUser\')}',
                data: {
                    phone: phone
                },
                dataType: 'json',
                type: 'post',
                success: function(e) {
                    console.log(e);
                    if(isEmpty(e.data.username)){
                        $('#username').val(e.data.username);
                        $('#name').val(e.data.cnname);
                        $('#cardno').val(e.data.cardnum);
                        $('#province').val(e.data.province);
                        $('#company').val(e.data.company);
                        $('#address').val(e.data.address);
                        $('#email').val(e.data.email);
                        $('#card_face_img').attr("src",e.data.card_face);
                        $('#card_back_img').attr("src",e.data.card_back);
                        $("#check_user").hide();
                    }
                    else
                    {
                        $('#name').val('');
                        $('#cardno').val('');
                        $('#username').val('');
                        $('#province').val('');
                        $('#company').val('');
                        $('#address').val('');
                        $('#email').val('');
                        $('#card_face_img').attr("src",'/static/images/default.png');
                        $('#card_back_img').attr("src",'/static/images/default.png');
                        $("#check_user").show();
                    }
                }
            });
        }
    });
</script>
</body>
</html>

